<!doctype html>
<meta charset="uft-8">

<script src="jquery.js"></script>
<script src="extensio-with-minitest.js"></script>
<script>

$(function () {

  /**
   * extensio Chrome tests. mt.fin is called in the shared tests.
   */
  mt.test('xio#chrome', function () {

    mt.ok(typeof xio === 'object', 'xio is an object.');
    
    mt.ok(xio.env === 1, 'xio detects chrome');
    mt.ok(xio.contentScript === false, 'xio detects not in a content script');

  });

  /**
   * Data URLs
   */
  mt.test('xio.data', function () {

    mt.ok(typeof xio.data === 'function', 'xio.data is a function.');
    
    // chrome-extension://abcdefghijklmnop/images/kitten.jpg
    var url = xio.data('res/example.txt');

    var pattern = /^chrome-extension:\/{2,}[a-z]+\/res\/example.txt$/g;

    mt.ok(url.match(pattern), 'returned url matches pattern');

  });


  /**
   * Ports
   */
  
  var connectionFired = false;

  mt.test('xio.script', function () {
    mt.equal(typeof xio.script, 'object', 'is an object');
  });

  mt.test('xio.script.on', function () {
    mt.equal(typeof xio.script.on, 'function', 'is a function');

    var testCallback = function ( port ) {
      mt.equal(typeof port, 'object', 'is an object');
      connectionFired = true;
    };

    // Basic port.on functionality
    var token = xio.script.on('connection', testCallback);

    mt.equal(typeof token, 'string', 'token is a string');

    mt.equal(xio.script.subscribers('connection').length, 1, 'xio.script.subscribers returns the correct length array of subscribers');

    mt.equal(xio.script.subscribers('connection')[0].token, token, 'xio.script.subscribers returns the correct token');
    mt.equal(xio.script.subscribers('connection')[0].cb, testCallback, 'xio.script.subscribers returns the callback');

    // Throws exceptions?
    try {
      xio.script.on({a: 123}, function ( port ) {});
    } catch (e) {
      mt.equal(e, 'xio : script.on event must be a string.', 'returns correct error message with object event');
    }

    try {
      xio.script.on('someEvent', 'loadOfRubbish');
    } catch (e) {
      mt.equal(e, 'xio : script.on callback must be a function.', 'return correct error message with string callback');
    }

  });

  mt.test('xio.script.publish', function () {

    xio.script.publish( 'connection', {} );

    mt.ok(connectionFired, 'connection was made');

  });

  mt.fin();

});

</script>